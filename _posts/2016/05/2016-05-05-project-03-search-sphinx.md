---  
layout: post  
title: 年轻司机介绍内部搜索系统与sphinx
description:  作为一个年轻的司机，　来公司已经两年了。刚来的时候，做了内部搜索系统，现在简单介绍一下.    
updateData:  00:22 2016/05/05
categories: [程序人生]
published: false
---  


## 项目背景

还在做关联商品的时候，就被告知接下来要做媒资内部搜索了。  
语言要求是c语言的搜索引擎。  
查了相关资料，成熟的搜索引擎竟然只有sphinx(14年)。  
那就使用这个开源软件来快速实现一个搜索系统吧。  


## 项目介绍

这里要使用开源搜索引擎快速实现一个搜索系统。  
搜索系统需要支持中文模糊搜索，　支持属性搜索, 非条件搜索等。  
sphinx都可以支持这些功能，　所以这里只需要学会使用sphinx即可实现这个系统。  

由于实际数据分布在多个不同的表中，　所以这里需要有个同步程序把数据汇总在一张大横表中。  
然后使用创建索引程序定时创建索引。  
搜索服务定时加载增量索引。  
搜索接口把充当协议转化层供外界使用。  

架构大概如下：  





## 项目实现


### 同步数据

由于目前还没有中转，　大家都是通过扫描DB的方式来得到增量更新的数据。  
比如对于视频，　这里定时扫描10张基础表得到更新的基础数据，　然后去10库百表里查询竖表数据(配置化增加字段)，最后去其他额外表得到其他数据并更新到sphinx　表中。  


这里使用python脚本语言快速实现了对应的逻辑。  

扫描DB的方式是指定时间之后的数据认为是新增数据。  
假设定时任务事件是1分钟, 这个时间一般会设置为2~3分钟，　这样是为了确保没有丢失数据。  


缺点: 当数据大量更新的时候，将会出现一些问题。  

1. 当程序做了唯一实例限制后，　假设程序运行大于1分钟，　下次程序运行时发现程序实例存在而退出，　这时就会丢数据。  
2. 如果不做唯一实例限制，　则每个1分钟就会增加一个实例，　数据量大时往往很消耗内存和CPU，又不断的新增实例，　可能影响机器性能，　极端情况下导致机器down掉。  

前段时间遇到一个事故：本来CPU已经很高了，　结果不知谁的脚本唯一实例写的有问题，　导致每分钟增加一个实例，那个脚本可能还做了很重的逻辑，　结果导致CPU毛刺很高，　极端情况下CPU持续一段时间都是100%, 最终机器受不了了，　down掉了。  


解决方案：  

如果可以接中转，　就使用中转吧。  


某些业务必须使用扫描形式时，　就需要使用标记的形式来扫描DB了。  

举个例子，　对于翻页逻辑，　怎么做才比较好呢?  
每次使用`limit offset,num` 固然可以实现功能，　但是这种方法当`offset`很大时性能就不好说了, 也就是这种方法性能是不稳定的。  
一种折中方案是`where 条件>lastId limit num`.  
然后如果条件可以利用上索引，　是不是性能立马就稳定了(这个方案也有问题但不是重点，　这里不做讨论)。  


我们扫描DB的方法类似。  
假设数据更新的时候，　会有一个递增唯一的序列号，　我们是不是只需要记录上次扫描的最大序列号即可。  
语句大概是这样：　`where seq > lastSeq order by seq limit 1000`.  
不幸的是我们的DB中往往没有序列号这样一个字段。  
那能不能使用某些字段来代替这个序列号呢？  
假设每条记录更新事件都不在同一秒，　我们是不是就可以使用时间戳这个字段来标示了？  
例如: `where mtime > lastmtime order by mtime limit 1000`  
不幸的事情很容易发生的，　通常情况下同一时间更新的数据会不知一条，　有人可能会说事件精确到毫秒，　同一毫秒下依然可能会更新很多数据。  
对于同一时间的数据，　我们可以发现还是可以区分的：　主键。  
我们通过时间加上主键是不是就可以唯一标示一个序列号了呢?  
例如: `where (mtime = lastmtime　and key > lastKey) or (mtime > lastmtime) order by mtime, key limit 1000`  

这样确实解决了序列号的问题，　但是却需要增加一个　mtime加key的索引。  


### 创建索引与搜索服务

一般创建索引支持两种模式：全量索引，　增量索引。  
全量索引很少运行，比如一天或一周，　甚至一月运行一次。  
增量索引几分钟就要运行一次。  
这里不介绍合并索引的事情了，大家可以把合并索理解为执行了一次全量索引，　然后更新增量索引的偏移时间即可.  
合并索引的时候并不会间断服务的。  


### 搜索接口  

搜索接口涉及到对内和对外。  
对外需要表现为一个标准的jsonp接口, 支持callback, json, xml等标准。  
对内则是把参数根据业务逻辑，　转化为搜索参数。  
由于这里使用的大横表，　所以不多说什么了，　没少技术含量, 只是简单的几个php语句。  



## sphinx介绍

sphinx 主要实现的功能是快速的进行全文检索。  




## 结语

结语  





