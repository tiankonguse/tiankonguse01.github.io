---   
layout:     post  
title:       浅谈推荐算法
description: 之前参加了虚拟项目，核心是推荐算法，这里简单谈谈推荐算法。    
keywords: 后台服务  
tags: [后台服务]  
categories: [程序人生]  
updateData:  23:28 2017/09/03  
published: false  
---  
  
  
>   
> 大家好，这里是tiankonguse的公众号(tiankonguse-code)。    
> tiankonguse曾是一名ACMer，现在是鹅厂视频部门的后台开发。    
> 这里主要记录算法，数学，计算机技术等好玩的东西。   
>      
> 这篇文章从公众号[tiankonguse-code](http://mp.weixin.qq.com/s/Cte5aGAGuwAQ5tmQXTPhGw)自动同步过来。    
> 如果转载请加上署名：公众号tiankonguse-code，并附上公众号二维码，谢谢。  
>   
>    
  

## 零、背景

16年底的时候，公司内部去北京培训了一周。  
期间需要做一个虚拟项目，我们组的课题就是推荐系统。  
当时对推荐领域进行了了解，并准备写推荐的文章，由于我并没有真实做过推荐系统，所以写了一半就半途而废了。  
现在快一年了，整理书签的时候看到收藏的文章，这里梳理一下。
由于没有实战经验，这里算是纯理论交流吧。  


## 一、最初的使用场景

推荐技术最初大多用在电子商务领域。  
由于很多人并不知道自己想要买什么，电商为了提高营收额，就想办法猜测你可能想要买什么，然后展现在你面前，你一看正是自己想要的，从而双方都很满意得到自己想要的东西了。  


上面这句话可能比较抽象，我举几个例子大家就清楚了。  
比如你去亚马逊购买《UNIX网络编程》，旁边看到推荐的有《UNIX环境高级编程》或者《UNIX编程艺术》。  
于是你就把《UNIX环境高级编程》也买走了，这就是推荐系统，买什么东西时还会推荐给你类似的东西。


另外一个例子就是啤酒与尿布了。  
你买了啤酒，发现旁边摆放的有尿布，于是你就想起还要买尿布，于是也买走了。  



这两个例子里面其实使用了不同的方法来给你推荐商品，但是目的是一样的：让你尽量多的买东西，从而商家提高营收。  


## 二、现在的使用场景


推荐技术在电商领域已经发展了几十年了，但是深入了解这个技术的人并不是那么多。  
2012年今日头条出世，2014年到2015年彻底火爆起来，推荐技术从而引起各大公司的重视，推荐职位水涨船高，人人都称自己了解推荐技术了。  


如今也是移动应用的时代，各大公司都尝试做了自己的推荐系统。  
由于不是卖东西，所以目的只能是想办法把用户留在自己的app上，至于怎么赚钱以后再说。    


新闻领域今日头条算是一匹黑马，刚出来的时候大家都没在意，发现不对劲的时候已经来不及了。  
音乐领域网易音乐也是嗅觉比较敏感，快速使用推荐技术推送懂你的音乐，大家都认为网易音乐最了解自己。  
视频领域起步就较晚了，前几年在和优酷斗争，后两年在和爱奇艺斗争，进入推荐之战自然就晚了。  


当然，之所以新闻最容易做推荐，视频不容易做推荐也是有原因的。  
新闻可以自动化分析文章是什么类型的，专业术语兼叫做提取特征。  
视频的话就比较难了，目前大家还都是拼人工打标签呢，后续视频能自动提取特征的话，视频的推荐才能真正火爆起来吧。  


## 二、推荐是怎么实现的






## 三、搜索上的实际应用


实际应用中我接触过sphinx和Elasticsearch。  
对于sphinx支持三种模式；增量普通模式、增量分布式模块、实时模式。  
而对于Elasticsearch只有一种模式：实时分布式模式。  


对于业务来说，服务一旦搭建起来，经常变更的有：增加减少机器，增加其他搜索资料，某个搜索资料加字段。  


对于sphinx，不管哪种模式，所有配置都是手动写死的，任何一种变更都需要间断服务。  
而对于Elasticsearch，我们都可以通过接口动态调整，而不需间断服务。  


下面我们分别来看看是怎么实现的吧.  



### 1. sphinx 增量普通模式  

上面在问题1：数据怎么更新里面提到了一般是重新储存一份数据。  
对于sphinx 增量普通模式，具体实现方式就是建两个索引：全量与增量。  


全量索引每天凌晨都重新加载全部数据。    
增量索引每隔几分钟就重新加载当天的数据。    
这两个合起来就可以伪实时的提供搜索服务了。  


对于重复问题，增量索引还提供指定哪些docId应该在全量索引中忽略.  
有了这个，聚合数据时对满足条件的数据进行过滤，就可以得到最终的结果了。  


是的，增量普通模式 只提供了上面这些功能，其他你能想到的功能都没有提供。  
比如原先支持对文章进行搜索，后来文章这个资料加了一个字段，sphinx就需要手动的修改配置来加字段，并重启服务。  
又比如我们要支持人名搜索了，也需要配置新的索引，也需要重启服务。  

索引配置大概如下：  


![](http://tiankonguse.com/lab/cloudLink/baidupan.php?url=/1915453531/3579000856.png)  


不管新增字段还是新增索引，都需要修改这个配置文件，并重启服务（服务启动需要很长时间的）。


### 2. sphinx 增量分布式模式

sphinx的分布式模式和普通模式只有一个区别:分布式。  
其他的完全一样，直接看配置吧。  


![](http://tiankonguse.com/lab/cloudLink/baidupan.php?url=/1915453531/523553231.png)  


多台机器分别读不同的数据。  
是的，你们没有看错，大部分人都是使用mysql的左值运算来进行分布式的。  
如果是我，我更倾向于分号段，即下面这种方式：`c_id <= 100000`，`c_id > 100000 and c_id <= 200000`，`c_id > 200000`。  
分号段的好处是后续可持续性扩容,而取模的方式是致命的（课后作业又来了，有什么缺点呢？）。


至于sphinx增量分布式模式的其他问题，和增量普通模式完全一样，这里只是新增的功能，然后新增了一些问题而已。  


### 3. sphinx 实时模式  

对于sphinx的实时模式，和普通模式相比增加了实时功能，但是放弃了数据源。  


什么意思呢？  
在普通模式下，sphinx是通过db来加载数据的，这样扩容什么的耗时浪费在重新加载DB数据并创建索引上.  
而对于实时模式，丢弃数据源意味着我们需要通过接口一条条来写数据，如果扩容了，就需要写全量数据。  
虽然和加载DB一样是导入全量数据，但是这个是通过api一条条写入的，最终影响是很严重的。  
加载DB的话我们可以在十几分钟完成，但是通过API的话，没有几个小时是加载不完的。  


另外就是加字段，扩容等面临着一堆问题等待我们去解决。  
sphinx仅仅是一个索引工具，只负责分词查出结果来，对于实际使用中的问题就需要自己去面对了。  



### 4. Elasticsearch实时分布式搜索


我们看到sphinx可谓是搜索引擎中最简单的引擎，只实现了分词与查询，对于小公司小项目使用还是可以接受的。  
但是项目重要程度提上来时，我们只能放弃sphinx了，使用更完善的搜索引擎才是最可行的方案。  
这里我选择了Elasticsearch，Elasticsearch简称ES。  

我们先来看看面对之前提到的问题，ES是怎么解决的。  


1. 数据更新：ES内部自己管理，不需要我们关心增量以及旧数据的问题。  
2. 多机更新：ES只需要写入一次数据，内部可以自动同步。  
3. 索引与字段：ES可以动态的增加索引或者增加字段。
4. 分布式：ES自身就是分布式的，内部会自动把部分数据同步到新机器。  
5. 页数：这个是任何搜索引擎都会面临的问题，需要产品形态上解决。  
6. 容灾：增加或减少机器后，我们不需要做任何操作，ES自己会管理这些，而且不会间断服务。  



好了，看完上面的对比，有人会反问难道ES就没缺点吗?  
当然不是，所有分词倒排的搜索引擎都会面临两个问题：倒排数量与页数。  


这两个问题实际在上面的页数问题里面都提到了，现在再回顾一下。  



还是搜索"hello word"，这里说的夸张点。"hello"可以匹配100W个数据，"word"可以匹配150W个数据。    
不知道大家看到数据后有什么第一感觉。  
我的第一认知是至少需要把100W数据和150W数据加载出来，才能进行聚合。  
这里的100W和200W就是我说的倒排数量问题。  


页数的问题是假设聚合后得到80W数据，我的请求数据是第70万开始，要10个。  
对我来说我只是要10个数据，对于后来来说至少需要先拉出70万多点数据才行。  
而对于分布式，每个节点都需要拉出70W多点数据,最后还需要聚合，不多说了。  

这就像大象放进冰箱里需要几步，不管怎么优化，都需要打开冰箱，放进去，关闭冰箱。  
搜索引擎的倒排数量和页数也是一个道理。  


最后看看ES的可视化管理图吧。  


![](http://tiankonguse.com/lab/cloudLink/baidupan.php?url=/1915453531/3327520873.png)  




## 二、总结

sphinx虽然很多问题，但是提供了最基本的搜索功能。  
所以大部分小公司和小项目还是可以使用这个软件的。  

但是项目大了重要了，面对可扩展性与容灾问题时，最终必然需要放弃这个软件。        

  
对了现在开通了公众号和小密圈。  
博客记录所有内容。  
技术含量最高的文章放在公众号发布。  
比较好玩的算法放在[小密圈](https://wx.xiaomiquan.com/mweb/views/joingroup/join_group.html?group_id=281548515451&secret=r0krqw9fw0at24vxjxo1uo4k0h4lfe47&extra=d67ce0c25ec91252b3af846a10154c9e9d4cb50c763fee178acd68cd2c2e09ee)发布。  
欢迎大家加入看各种算法的思路。  

![](/images/tiankonguse-algorithms.png)  
  
  
长按图片关注公众号，阅读不一样的技术文章。   
  
![](/images/tiankonguse-code.gif)  
  
  